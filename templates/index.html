<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø³ØªØ²Ù„ÛŒ | Assetly</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- Custom Font (Vazirmatn) -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <style>
        /* Ø§Ø¹Ù…Ø§Ù„ ÙÙˆÙ†Øª Vazirmatn Ø±ÙˆÛŒ Ù‡Ù…Ù‡ Ø§Ø¬Ø²Ø§ */
        * {
            font-family: 'Vazirmatn', sans-serif !important;
        }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÙ‡ */
        body { 
            background-color: #0d1117; 
            color: #c9d1d9;
            background-image: radial-gradient(circle at 1px 1px, rgba(255, 255, 255, 0.04) 1px, transparent 0); 
            background-size: 25px 25px; 
            min-height: 100vh;
        }
        
        /* Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§Ø¹Ù…Ø§Ù„ ÙÙˆÙ†Øª */
        input, select, textarea, button, table, th, td, span, p, h1, h2, h3, h4, h5, h6 {
            font-family: 'Vazirmatn', sans-serif !important;
        }
        
        /* Ø¨Ø±Ø§ÛŒ Ø§Ø¹Ø¯Ø§Ø¯ */
        .font-mono {
            font-family: 'Vazirmatn', monospace !important;
        }
        
        /* Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ø§Ø± */
        ::-webkit-scrollbar { width: 6px; height: 6px; } 
        ::-webkit-scrollbar-track { background: #0d1117; } 
        ::webkit-scrollbar-corner { background: #0d1117; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 3px; } 
        ::-webkit-scrollbar-thumb:hover { background: #4f5861; }
        
        /* Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ */
        .card { background-color: #161b22; border: 1px solid #30363d; }
        .success { color: #34d399; }
        .danger { color: #f87171; }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ú©Ø´ÙˆÛŒÛŒâ€ŒÙ‡Ø§ */
        .category-toggle {
            cursor: pointer;
            outline: none;
        }
        
        .category-toggle:focus {
            outline: none;
        }
        
        .category-toggle svg {
            transition: transform 0.3s ease;
        }
        
        /* Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ø§Ø± Ø¨Ø±Ø§ÛŒ Ú©Ø´ÙˆÛŒÛŒâ€ŒÙ‡Ø§ */
        #gold_coin-prices::-webkit-scrollbar,
        #currency-prices::-webkit-scrollbar,
        #crypto-prices::-webkit-scrollbar {
            width: 3px;
        }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø±ÛŒØ³Ù¾Ø§Ù†Ø³ÛŒÙˆ */
        .modal-container {
            max-height: 90vh;
            overflow-y: auto;
            width: 100%;
        }
        
        .modal-content {
            width: 95%;
            max-width: 500px;
            margin: auto;
        }
        
        @media (min-width: 640px) {
            .modal-content {
                width: 90%;
                max-width: 550px;
            }
        }
        
        @media (min-width: 768px) {
            .modal-content {
                width: 85%;
                max-width: 600px;
            }
        }
        
        @media (min-width: 1024px) {
            .modal-content {
                width: 80%;
                max-width: 650px;
            }
        }
        
        /* Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¯Ø§Ù„ ØªØ­Ù„ÛŒÙ„ (Ø¨Ø²Ø±Ú¯â€ŒØªØ±) */
        .comparison-modal-content {
            width: 98%;
            max-width: 98vw;
            margin: auto;
        }
        
        @media (min-width: 640px) {
            .comparison-modal-content {
                width: 95%;
                max-width: 95vw;
            }
        }
        
        @media (min-width: 768px) {
            .comparison-modal-content {
                width: 92%;
                max-width: 92vw;
            }
        }
        
        @media (min-width: 1024px) {
            .comparison-modal-content {
                width: 90%;
                max-width: 90vw;
            }
        }
        
        @media (min-width: 1280px) {
            .comparison-modal-content {
                width: 85%;
                max-width: 85vw;
            }
        }
        
        /* Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¹Ù…ÙˆØ¯ÛŒ Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§ */
        .modal-scroll {
            max-height: 65vh;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        @media (min-width: 768px) {
            .modal-scroll {
                max-height: 70vh;
            }
        }
        
        /* Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¯Ø§Ù„ */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(-10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-fade {
            animation: fadeIn 0.2s ease-out;
        }
        
        .modal-slide {
            animation: slideIn 0.3s ease-out;
        }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª */
        .action-btn {
            transition: all 0.2s ease;
        }
        
        .action-btn:hover {
            transform: translateY(-1px);
        }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ inputÙ‡Ø§ÛŒ date Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            opacity: 0.7;
            cursor: pointer;
        }
        
        /* Ø¨Ù‡Ø¨ÙˆØ¯ Ù†Ù…Ø§ÛŒØ´ dropdownÙ‡Ø§ Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23c9d1d9' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: left 0.5rem center;
            background-size: 1.2em;
            padding-left: 2.5rem;
        }
        
        /* Ø¨Ù‡Ø¨ÙˆØ¯ Ù†Ù…Ø§ÛŒØ´ Ø¬Ø¯Ø§ÙˆÙ„ Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ù‚Ø¯Ø±Øª Ø®Ø±ÛŒØ¯ */
        .purchase-card {
            transition: all 0.3s ease;
        }
        
        .purchase-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        /* Ø¨Ù‡Ø¨ÙˆØ¯ Ù†Ù…Ø§ÛŒØ´ ÙØ±Ù…â€ŒÙ‡Ø§ Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ */
        .form-input-mobile {
            font-size: 16px !important; /* Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø²ÙˆÙ… Ø¯Ø± iOS */
        }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÙˆÙ„â€ŒØ¨Ø§Ø± Ù…ÙˆØ¯Ø§Ù„ */
        .modal-scroll::-webkit-scrollbar {
            width: 4px;
        }
        
        .modal-scroll::-webkit-scrollbar-track {
            background: #161b22;
        }
        
        .modal-scroll::-webkit-scrollbar-thumb {
            background: #4f5861;
            border-radius: 2px;
        }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡ Ú©Ø´ÙˆÛŒÛŒ Ù‚Ø¯Ø±Øª Ø®Ø±ÛŒØ¯ */
        .purchase-toggle {
            transition: all 0.3s ease;
        }
        
        .purchase-toggle.active {
            background-color: #3b82f6;
            color: white;
        }
        
        .purchase-toggle.inactive {
            background-color: #374151;
            color: #9ca3af;
        }
    </style>
</head>
<body class="p-3 sm:p-4 md:p-6">

    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 md:mb-8 gap-4">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-200">Assetly | Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø±ÙÙ‡ Ø§ÛŒ Ù¾ÙˆØ±ØªÙÙˆÛŒ</h1>
            <div class="flex flex-wrap gap-2 sm:gap-3 w-full sm:w-auto">
                <button onclick="openComparisonModal()" class="flex-1 sm:flex-none bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-3 sm:px-4 rounded-lg shadow-lg transition duration-200 action-btn text-sm sm:text-base">
                    ğŸ“Š ØªØ­Ù„ÛŒÙ„ Ø§Ø±Ø²Ø´
                </button>
                <button id="add-transaction-btn" class="flex-1 sm:flex-none bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-3 sm:px-4 rounded-lg shadow-lg transition duration-200 action-btn text-sm sm:text-base">
                    + Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´
                </button>
            </div>
        </header>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 sm:gap-6">
            
            <!-- A. Portfolio Summary & Chart (Main Column) -->
            <div class="lg:col-span-9 space-y-4 sm:space-y-6">
                
                <!-- Summary Cards -->
                <div id="summary-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                    <!-- Total Value Card -->
                    <div class="card p-4 sm:p-6 rounded-xl shadow-xl transition duration-300 hover:shadow-2xl purchase-card">
                        <p class="text-sm text-gray-400 mb-2">Ø§Ø±Ø²Ø´ Ú©Ù„ Ù¾ÙˆØ±ØªÙÙˆÛŒ (ØªÙˆÙ…Ø§Ù†)</p>
                        <p id="total-value" class="text-2xl sm:text-3xl font-extrabold text-white">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
                        <span id="total-profit-pct" class="text-sm mt-1 flex items-center"></span>
                    </div>

                    <!-- Total Profit/Loss Card -->
                    <div class="card p-4 sm:p-6 rounded-xl shadow-xl transition duration-300 hover:shadow-2xl purchase-card">
                        <p class="text-sm text-gray-400 mb-2">Ø³ÙˆØ¯ / Ø²ÛŒØ§Ù† Ø®Ø§Ù„Øµ (ØªÙˆÙ…Ø§Ù†)</p>
                        <p id="total-profit" class="text-2xl sm:text-3xl font-extrabold text-white">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
                        <span class="text-xs text-gray-500 mt-1">Ø§Ø² Ø§Ø¨ØªØ¯Ø§ÛŒ ÙØ¹Ø§Ù„ÛŒØª</span>
                    </div>

                    <!-- Rial Wallet Card -->
                    <div class="card p-4 sm:p-6 rounded-xl shadow-xl transition duration-300 hover:shadow-2xl purchase-card">
                        <p class="text-sm text-gray-400 mb-2">Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø±ÛŒØ§Ù„ÛŒ (Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø®Ø§Ù„Øµ)</p>
                        <p id="rial-wallet-balance" class="text-2xl sm:text-3xl font-extrabold text-white">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
                        <button onclick="openWalletModal()" class="text-blue-400 text-sm mt-1 hover:text-blue-300 transition duration-200">
                            Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ§Ø±ÛŒØ² / Ø¨Ø±Ø¯Ø§Ø´Øª
                        </button>
                    </div>
                </div>

                <!-- Daily Profit/Loss Section -->
                <div class="card p-4 sm:p-6 rounded-xl shadow-xl transition duration-300 hover:shadow-2xl">
                    <h2 class="text-lg font-semibold mb-3 text-gray-200">ğŸ“ˆ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø±ÙˆØ²Ø§Ù†Ù‡</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4">
                        <!-- Ø³ÙˆØ¯/Ø²ÛŒØ§Ù† Ø±ÙˆØ²Ø§Ù†Ù‡ (ØªÙˆÙ…Ø§Ù†) -->
                        <div class="p-3 bg-gray-800 rounded-lg">
                            <p class="text-xs text-gray-400 mb-1">Ø³ÙˆØ¯/Ø²ÛŒØ§Ù† Ø§Ù…Ø±ÙˆØ²</p>
                            <p id="daily-profit-toman" class="text-xl sm:text-2xl font-bold text-white">-</p>
                        </div>
                        
                        <!-- Ø¯Ø±ØµØ¯ Ø³ÙˆØ¯/Ø²ÛŒØ§Ù† Ø±ÙˆØ²Ø§Ù†Ù‡ -->
                        <div class="p-3 bg-gray-800 rounded-lg">
                            <p class="text-xs text-gray-400 mb-1">Ø¯Ø±ØµØ¯ ØªØºÛŒÛŒØ± Ø§Ù…Ø±ÙˆØ²</p>
                            <p id="daily-profit-percent" class="text-xl sm:text-2xl font-bold text-white">-</p>
                        </div>
                        
                        <!-- Ø§Ø±Ø²Ø´ Ú©Ù„ Ø¯Ø± Ù¾Ø§ÛŒØ§Ù† Ø±ÙˆØ² Ù‚Ø¨Ù„ -->
                        <div class="p-3 bg-gray-800 rounded-lg">
                            <p class="text-xs text-gray-400 mb-1">Ø§Ø±Ø²Ø´ Ø¯ÛŒØ±ÙˆØ²</p>
                            <p id="yesterday-value" class="text-xl sm:text-2xl font-bold text-white">-</p>
                        </div>
                    </div>
                    <div class="mt-3 text-center">
                        <button onclick="showDailyHistory()" class="text-blue-400 text-sm hover:text-blue-300 transition duration-200">
                            Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø±ÙˆØ²Ø§Ù†Ù‡
                        </button>
                    </div>
                </div>

                <!-- Purchase Power Box -->
                <div class="card p-4 rounded-xl shadow-xl">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-lg font-semibold text-gray-200">ğŸ’° Ù‚Ø¯Ø±Øª Ø®Ø±ÛŒØ¯</h2>
                        <div class="relative inline-block w-32">
                            <!-- Toggle Switch -->
                            <div class="flex items-center bg-gray-700 rounded-full p-1">
                                <button id="purchase-mode-balance" 
                                        class="flex-1 py-1 px-2 text-xs rounded-full transition-all duration-200 bg-blue-600 text-white purchase-toggle active">
                                    Ú©ÛŒÙ Ø±ÛŒØ§Ù„ÛŒ
                                </button>
                                <button id="purchase-mode-portfolio" 
                                        class="flex-1 py-1 px-2 text-xs rounded-full transition-all duration-200 text-gray-300 purchase-toggle inactive">
                                    Ú©Ù„ Ù¾ÙˆØ±ØªÙÙˆ
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="purchase-power-box" class="space-y-3">
                        <div class="flex items-center justify-between p-3 bg-gray-800 rounded-lg purchase-card">
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded-full bg-yellow-500 flex items-center justify-center mr-2">
                                    <span class="text-white text-sm">$</span>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-300">Ø¯Ù„Ø§Ø± Ø¢Ù…Ø±ÛŒÚ©Ø§</p>
                                    <p id="usd-purchase" class="text-xs text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡...</p>
                                </div>
                            </div>
                            <span id="usd-amount" class="font-mono text-white text-sm sm:text-base">-</span>
                        </div>
                        
                        <div class="flex items-center justify-between p-3 bg-gray-800 rounded-lg purchase-card">
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded-full bg-yellow-400 flex items-center justify-center mr-2">
                                    <span class="text-white text-sm">G</span>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-300">Ú¯Ø±Ù… Ø·Ù„Ø§</p>
                                    <p id="gold-purchase" class="text-xs text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡...</p>
                                </div>
                            </div>
                            <span id="gold-amount" class="font-mono text-white text-sm sm:text-base">-</span>
                        </div>
                        
                        <div class="flex items-center justify-between p-3 bg-gray-800 rounded-lg purchase-card">
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center mr-2">
                                    <span class="text-white text-sm">â‚¿</span>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-300">Ø¨ÛŒØªâ€ŒÚ©ÙˆÛŒÙ†</p>
                                    <p id="btc-purchase" class="text-xs text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡...</p>
                                </div>
                            </div>
                            <span id="btc-amount" class="font-mono text-white text-sm sm:text-base">-</span>
                        </div>
                    </div>
                    <p id="purchase-power-info" class="text-xs text-gray-500 mt-3 text-center">Ø¨Ø§ Ú©Ù„ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø±ÛŒØ§Ù„ÛŒ</p>
                </div>

                <!-- Performance Chart -->
                <div class="card p-4 sm:p-6 rounded-xl shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-gray-200">Ù†Ù…ÙˆØ¯Ø§Ø± Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù¾ÙˆØ±ØªÙÙˆÛŒ</h2>
                    <div class="h-64 sm:h-80 md:h-96">
                        <canvas id="portfolioChart"></canvas>
                    </div>
                </div>

                <!-- Assets Table -->
                <div class="card p-4 sm:p-6 rounded-xl shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-gray-200">Ø¯Ø§Ø±Ø§ÛŒÛŒâ€ŒÙ‡Ø§ÛŒ Ø§Ø³Ù¾Ø§Øª</h2>
                    <div class="table-responsive">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead>
                                <tr class="text-xs sm:text-sm text-gray-400 uppercase tracking-wider">
                                    <th class="px-2 py-2 sm:px-3 sm:py-3 text-right">Ù†Ø§Ù… Ø¯Ø§Ø±Ø§ÛŒÛŒ (Ø¯Ø³ØªÙ‡)</th>
                                    <th class="px-2 py-2 sm:px-3 sm:py-3 text-right">Ù‚ÛŒÙ…Øª Ø³Ø± Ø¨Ù‡ Ø³Ø±</th>
                                    <th class="px-2 py-2 sm:px-3 sm:py-3 text-right">Ù‚ÛŒÙ…Øª Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ</th>
                                    <th class="px-2 py-2 sm:px-3 sm:py-3 text-right">Ù…ÙˆØ¬ÙˆØ¯ÛŒ</th>
                                    <th class="px-2 py-2 sm:px-3 sm:py-3 text-right">Ø§Ø±Ø²Ø´ Ú©Ù„</th>
                                    <th class="px-2 py-2 sm:px-3 sm:py-3 text-right">Ø³ÙˆØ¯ / Ø²ÛŒØ§Ù†</th>
                                    <th class="px-2 py-2 sm:px-3 sm:py-3 text-center">Ø¹Ù…Ù„ÛŒØ§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="assets-table-body" class="divide-y divide-gray-800">
                                <tr><td colspan="7" class="py-4 text-center text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø±Ø§ÛŒÛŒâ€ŒÙ‡Ø§...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>

            <!-- B. Live Prices Sidebar (Side Column) -->
            <div class="lg:col-span-3 space-y-4 sm:space-y-6">
                <div class="card p-4 rounded-xl shadow-xl sticky top-4">
                    <h2 class="text-xl font-semibold mb-4 text-gray-200">Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ÛŒ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ (ØªÙˆÙ…Ø§Ù†)</h2>
                    <p id="last-updated" class="text-xs text-gray-500 mb-4">Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: -</p>
                    
                    <!-- Ù†Ù…Ø§ÛŒØ´ Ù‚ÛŒÙ…Øª Ø¯Ø§Ø±Ø§ÛŒÛŒâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø± Ù¾ÙˆØ±ØªÙÙˆ -->
                    <div id="portfolio-prices" class="mb-6">
                        <h3 class="text-lg font-medium mb-3 text-blue-400 border-b border-gray-700 pb-2">Ø¯Ø§Ø±Ø§ÛŒÛŒâ€ŒÙ‡Ø§ÛŒ Ù¾ÙˆØ±ØªÙÙˆ</h3>
                        <div id="portfolio-prices-list" class="space-y-3">
                            <p class="text-gray-500 text-sm text-center py-2">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
                        </div>
                    </div>
                    
                    <!-- Ú©Ø´ÙˆÛŒÛŒâ€ŒÙ‡Ø§ -->
                    <div class="space-y-4">
                        <!-- Ø·Ù„Ø§ Ùˆ Ø³Ú©Ù‡ -->
                        <div class="border border-gray-700 rounded-lg overflow-hidden">
                            <button class="category-toggle w-full text-right p-3 bg-gray-800 hover:bg-gray-700 transition duration-200 flex justify-between items-center" data-category="gold_coin">
                                <span class="font-medium text-gray-200">Ø·Ù„Ø§ Ùˆ Ø³Ú©Ù‡</span>
                                <svg class="w-5 h-5 text-gray-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="gold_coin-prices" class="hidden p-3 bg-gray-900 space-y-2 max-h-60 overflow-y-auto">
                                <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ø·Ù„Ø§ Ùˆ Ø³Ú©Ù‡ -->
                            </div>
                        </div>
                        
                        <!-- Ø§Ø±Ø² -->
                        <div class="border border-gray-700 rounded-lg overflow-hidden">
                            <button class="category-toggle w-full text-right p-3 bg-gray-800 hover:bg-gray-700 transition duration-200 flex justify-between items-center" data-category="currency">
                                <span class="font-medium text-gray-200">Ø§Ø±Ø²</span>
                                <svg class="w-5 h-5 text-gray-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="currency-prices" class="hidden p-3 bg-gray-900 space-y-2 max-h-60 overflow-y-auto">
                                <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ø§Ø±Ø² -->
                            </div>
                        </div>
                        
                        <!-- Ø§Ø±Ø² Ø¯ÛŒØ¬ÛŒØªØ§Ù„ -->
                        <div class="border border-gray-700 rounded-lg overflow-hidden">
                            <button class="category-toggle w-full text-right p-3 bg-gray-800 hover:bg-gray-700 transition duration-200 flex justify-between items-center" data-category="crypto">
                                <span class="font-medium text-gray-200">Ø§Ø±Ø² Ø¯ÛŒØ¬ÛŒØªØ§Ù„</span>
                                <svg class="w-5 h-5 text-gray-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="crypto-prices" class="hidden p-3 bg-gray-900 space-y-2 max-h-60 overflow-y-auto">
                                <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ø§Ø±Ø² Ø¯ÛŒØ¬ÛŒØªØ§Ù„ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Modals -->

    <!-- 1. Transaction Modal -->
    <div id="transaction-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden transition-opacity flex items-center justify-center p-2 sm:p-4 modal-fade">
        <div class="modal-container">
            <div class="modal-content card p-4 sm:p-6 rounded-xl shadow-2xl transition-transform duration-300 transform scale-100 modal-slide">
                <div class="flex justify-between items-center mb-4 sm:mb-6">
                    <h3 class="text-lg sm:text-xl font-bold text-white">Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´</h3>
                    <button type="button" data-close-modal="transaction-modal" class="text-gray-400 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„ -->
                <div id="wallet-balance-display" class="mb-4 p-3 bg-gray-800 rounded-lg hidden">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-300">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„:</span>
                        <span id="current-wallet-balance" class="font-mono text-green-400 text-sm sm:text-base"></span>
                    </div>
                    <div class="mt-2 text-xs text-gray-400">
                        <span id="purchase-power-info-modal"></span>
                    </div>
                </div>
                
                <div class="modal-scroll">
                    <form id="transaction-form">
                        <div class="space-y-3 sm:space-y-4">
                            
                            <!-- Transaction Type -->
                            <div>
                                <label for="tx-type" class="block text-sm font-medium mb-1">Ù†ÙˆØ¹ ØªØ±Ø§Ú©Ù†Ø´</label>
                                <select id="tx-type" name="type" required class="form-input-mobile w-full p-2 text-sm sm:text-base rounded-lg bg-gray-700 border border-gray-600 text-white focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                                    <option value="buy">Ø®Ø±ÛŒØ¯ (Buy)</option>
                                    <option value="sell">ÙØ±ÙˆØ´ (Sell)</option>
                                    <option value="save_profit">Ø³ÛŒÙˆ Ø³ÙˆØ¯ (Save Profit)</option>
                                    <option value="deposit">ÙˆØ§Ø±ÛŒØ² Ø¨Ù‡ Ú©ÛŒÙ Ø±ÛŒØ§Ù„ÛŒ (Deposit)</option>
                                    <option value="withdrawal">Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø² Ú©ÛŒÙ Ø±ÛŒØ§Ù„ÛŒ (Withdrawal)</option>
                                </select>
                            </div>

                            <!-- Manual Date Input -->
                            <div>
                                <label for="tx-date" class="block text-sm font-medium mb-1">ØªØ§Ø±ÛŒØ® ØªØ±Ø§Ú©Ù†Ø´</label>
                                <div class="flex space-x-2 space-x-reverse">
                                    <input type="date" id="tx-date" name="date" class="form-input-mobile w-full p-2 text-sm sm:text-base rounded-lg bg-gray-700 border border-gray-600 text-white focus:ring-blue-500 focus:border-blue-500">
                                    <button type="button" id="reset-date" class="px-3 text-sm rounded-lg bg-gray-600 hover:bg-gray-700 text-white transition duration-200 whitespace-nowrap">Ø§Ù…Ø±ÙˆØ²</button>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Ø®Ø§Ù„ÛŒ Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯ Ø¨Ø±Ø§ÛŒ ØªØ§Ø±ÛŒØ® ÙØ¹Ù„ÛŒ</p>
                            </div>

                            <!-- Asset Type (Hidden for Deposit/Withdrawal) -->
                            <div id="asset-type-group">
                                <label for="asset-type" class="block text-sm font-medium mb-1">Ù†ÙˆØ¹ Ø¯Ø§Ø±Ø§ÛŒÛŒ</label>
                                <select id="asset-type" class="form-input-mobile w-full p-2 text-sm sm:text-base rounded-lg bg-gray-700 border border-gray-600 text-white focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                                    <option value="crypto">Ø§Ø±Ø² Ø¯ÛŒØ¬ÛŒØªØ§Ù„</option>
                                    <option value="gold_coin">Ø·Ù„Ø§ Ùˆ Ø³Ú©Ù‡</option>
                                    <option value="currency">Ø§Ø±Ø²</option>
                                </select>
                            </div>
                            
                            <!-- Asset Name/Symbol (Hidden for Deposit/Withdrawal) -->
                            <div id="asset-name-group">
                                <label for="asset-name" class="block text-sm font-medium mb-1">Ù†Ø§Ù… Ø¯Ø§Ø±Ø§ÛŒÛŒ / Ù†Ù…Ø§Ø¯</label>
                                <select id="asset-name" name="symbol" required disabled class="form-input-mobile w-full p-2 text-sm sm:text-base rounded-lg bg-gray-700 border border-gray-600 text-white focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">...</option>
                                </select>
                            </div>

                            <!-- Category -->
                            <div id="category-group">
                                <label for="tx-category" class="block text-sm font-medium mb-1">Ø¯Ø³ØªÙ‡ Ø¨Ù†Ø¯ÛŒ Ø³ÙØ§Ø±Ø´</label>
                                <input type="text" id="tx-category" name="category" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø®Ø±ÛŒØ¯ Ø§ÙˆÙ„ØŒ Ù†ÙˆØ³Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ..." class="form-input-mobile w-full p-2 text-sm sm:text-base rounded-lg bg-gray-700 border border-gray-600 text-white focus:ring-blue-500 focus:border-blue-500">
                            </div>

                            <!-- Quantity -->
                            <div>
                                <label for="tx-quantity" class="block text-sm font-medium mb-1"><span id="quantity-label">Ù…Ù‚Ø¯Ø§Ø±</span></label>
                                <input type="number" step="any" id="tx-quantity" name="quantity" required placeholder="Ù…Ù‚Ø¯Ø§Ø±" class="form-input-mobile w-full p-2 text-sm sm:text-base rounded-lg bg-gray-700 border border-gray-600 text-white focus:ring-blue-500 focus:border-blue-500">
                            </div>

                            <!-- Price Per Unit (Hidden for Deposit/Withdrawal) -->
                            <div id="price-per-unit-group">
                                <label for="tx-price" class="block text-sm font-medium mb-1">Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯ (Ø¨Ù‡ ØªÙˆÙ…Ø§Ù†)</label>
                                <input type="number" step="any" id="tx-price" name="price_per_unit" placeholder="Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯ Ø¨Ù‡ ØªÙˆÙ…Ø§Ù†" class="form-input-mobile w-full p-2 text-sm sm:text-base rounded-lg bg-gray-700 border border-gray-600 text-white focus:ring-blue-500 focus:border-blue-500">
                            </div>

                            <!-- Comment -->
                            <div id="comment-group">
                                <label for="tx-comment" class="block text-sm font-medium mb-1">Ú©Ø§Ù…Ù†Øª / ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
                                <textarea id="tx-comment" name="comment" rows="2" placeholder="Ø¬Ø²Ø¦ÛŒØ§Øª Ø§ÛŒÙ† ØªØ±Ø§Ú©Ù†Ø´ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" class="form-input-mobile w-full p-2 text-sm sm:text-base rounded-lg bg-gray-700 border border-gray-600 text-white focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>

                        </div>

                        <div id="tx-message" class="text-sm mt-3 hidden"></div>

                        <div class="mt-6 flex justify-end space-x-3 space-x-reverse">
                            <button type="button" data-close-modal="transaction-modal" class="py-2 px-4 rounded-lg text-gray-400 hover:text-white transition duration-200">Ù„ØºÙˆ</button>
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200">Ø«Ø¨Øª</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. History Modal -->
    <div id="history-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden transition-opacity flex items-center justify-center p-2 sm:p-4 modal-fade">
        <div class="modal-container">
            <div class="modal-content card p-4 sm:p-6 rounded-xl shadow-2xl transition-transform duration-300 transform scale-100 modal-slide">
                <div class="flex justify-between items-center mb-4 sm:mb-6">
                    <h3 id="history-title" class="text-lg sm:text-xl font-bold text-white">ØªØ§Ø±ÛŒØ®Ú†Ù‡ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</h3>
                    <button type="button" data-close-modal="history-modal" class="text-gray-400 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="modal-scroll">
                    <div class="table-responsive">
                        <table class="min-w-full divide-y divide-gray-700 text-xs sm:text-sm">
                            <thead class="sticky top-0 bg-gray-800">
                                <tr class="text-gray-400 uppercase tracking-wider">
                                    <th class="px-2 py-1 sm:px-3 sm:py-2 text-right">ØªØ§Ø±ÛŒØ®</th>
                                    <th class="px-2 py-1 sm:px-3 sm:py-2 text-right">Ù†ÙˆØ¹ (Ø¯Ø³ØªÙ‡)</th>
                                    <th class="px-2 py-1 sm:px-3 sm:py-2 text-right">Ù…Ù‚Ø¯Ø§Ø±</th>
                                    <th class="px-2 py-1 sm:px-3 sm:py-2 text-right">Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯</th>
                                    <th class="px-2 py-1 sm:px-3 sm:py-2 text-right">Ú©Ø§Ù…Ù†Øª</th>
                                    <th class="px-2 py-1 sm:px-3 sm:py-2 text-center">Ø¹Ù…Ù„ÛŒØ§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body" class="divide-y divide-gray-800">
                                <!-- History transactions will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="mt-6 flex justify-end">
                    <button type="button" data-close-modal="history-modal" class="py-2 px-4 rounded-lg bg-gray-600 hover:bg-gray-700 text-white transition duration-200">Ø¨Ø³ØªÙ†</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Wallet Management Modal -->
    <div id="wallet-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden transition-opacity flex items-center justify-center p-2 sm:p-4 modal-fade">
        <div class="modal-container">
            <div class="modal-content card p-4 sm:p-6 rounded-xl shadow-2xl modal-slide">
                <div class="flex justify-between items-center mb-4 sm:mb-6">
                    <h3 class="text-lg sm:text-xl font-bold text-white">Ù…Ø¯ÛŒØ±ÛŒØª Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø±ÛŒØ§Ù„ÛŒ</h3>
                    <button type="button" data-close-modal="wallet-modal" class="text-gray-400 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="wallet-current-balance" class="mb-4 text-center text-xl sm:text-2xl font-bold text-green-400">Ù…ÙˆØ¬ÙˆØ¯ÛŒ: -</div>
                <p class="text-gray-400 mb-4 text-sm text-right">Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª ÙˆØ§Ø±ÛŒØ² ÛŒØ§ Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø² Ú©ÛŒÙ Ù¾ÙˆÙ„ØŒ Ù„Ø·ÙØ§Ù‹ Ø§Ø² ÙØ±Ù… Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯. Ø§ÛŒÙ† Ø¨Ø®Ø´ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø§Ø³Øª.</p>
                <div class="mt-6 flex justify-end">
                    <button type="button" data-close-modal="wallet-modal" class="py-2 px-4 rounded-lg bg-gray-600 hover:bg-gray-700 text-white transition duration-200">Ø¨Ø³ØªÙ†</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. Edit Transaction Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden transition-opacity flex items-center justify-center p-2 sm:p-4 modal-fade">
        <div class="modal-container">
            <div class="modal-content card p-4 sm:p-6 rounded-xl shadow-2xl transition-transform duration-300 transform scale-100 modal-slide">
                <div class="flex justify-between items-center mb-4 sm:mb-6">
                    <h3 class="text-lg sm:text-xl font-bold text-white">ÙˆÛŒØ±Ø§ÛŒØ´ ØªØ±Ø§Ú©Ù†Ø´</h3>
                    <button type="button" data-close-modal="edit-modal" class="text-gray-400 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="modal-scroll">
                    <form id="edit-form">
                        <input type="hidden" id="edit-transaction-id">
                        <input type="hidden" id="edit-asset-id">
                        
                        <div class="space-y-3 sm:space-y-4">
                            <!-- Transaction Type (Readonly for save_profit) -->
                            <div>
                                <label for="edit-tx-type" class="block text-sm font-medium mb-1">Ù†ÙˆØ¹ ØªØ±Ø§Ú©Ù†Ø´</label>
                                <select id="edit-tx-type" name="type" required disabled class="form-input-mobile w-full p-2 text-sm sm:text-base rounded-lg bg-gray-700 border border-gray-600 text-white">
                                    <option value="buy">Ø®Ø±ÛŒØ¯ (Buy)</option>
                                    <option value="sell">ÙØ±ÙˆØ´ (Sell)</option>
                                    <option value="save_profit">Ø³ÛŒÙˆ Ø³ÙˆØ¯ (Save Profit)</option>
                                    <option value="deposit">ÙˆØ§Ø±ÛŒØ² (Deposit)</option>
                                    <option value="withdrawal">Ø¨Ø±Ø¯Ø§Ø´Øª (Withdrawal)</option>
                                </select>
                            </div>

                            <!-- Date Input -->
                            <div>
                                <label for="edit-tx-date" class="block text-sm font-medium mb-1">ØªØ§Ø±ÛŒØ® ØªØ±Ø§Ú©Ù†Ø´</label>
                                <input type="date" id="edit-tx-date" name="date" class="form-input-mobile w-full p-2 text-sm sm:text-base rounded-lg bg-gray-700 border border-gray-600 text-white focus:ring-blue-500 focus:border-blue-500">
                            </div>

                            <!-- Asset Name (Readonly) -->
                            <div id="edit-asset-name-group">
                                <label class="block text-sm font-medium mb-1">Ù†Ø§Ù… Ø¯Ø§Ø±Ø§ÛŒÛŒ</label>
                                <p id="edit-asset-name" class="p-2 text-sm sm:text-base rounded-lg bg-gray-700 border border-gray-600 text-white"></p>
                            </div>

                            <!-- Category -->
                            <div>
                                <label for="edit-tx-category" class="block text-sm font-medium mb-1">Ø¯Ø³ØªÙ‡ Ø¨Ù†Ø¯ÛŒ Ø³ÙØ§Ø±Ø´</label>
                                <input type="text" id="edit-tx-category" name="category" placeholder="Ø¯Ø³ØªÙ‡ Ø¨Ù†Ø¯ÛŒ" class="form-input-mobile w-full p-2 text-sm sm:text-base rounded-lg bg-gray-700 border border-gray-600 text-white focus:ring-blue-500 focus:border-blue-500">
                            </div>

                            <!-- Quantity -->
                            <div>
                                <label for="edit-tx-quantity" class="block text-sm font-medium mb-1">Ù…Ù‚Ø¯Ø§Ø±</label>
                                <input type="number" step="any" id="edit-tx-quantity" name="quantity" required class="form-input-mobile w-full p-2 text-sm sm:text-base rounded-lg bg-gray-700 border border-gray-600 text-white focus:ring-blue-500 focus:border-blue-500">
                            </div>

                            <!-- Price Per Unit (for buy/sell/save_profit) -->
                            <div id="edit-price-per-unit-group">
                                <label for="edit-tx-price" class="block text-sm font-medium mb-1">Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯ (ØªÙˆÙ…Ø§Ù†)</label>
                                <input type="number" step="any" id="edit-tx-price" name="price_per_unit" class="form-input-mobile w-full p-2 text-sm sm:text-base rounded-lg bg-gray-700 border border-gray-600 text-white focus:ring-blue-500 focus:border-blue-500">
                            </div>

                            <!-- Comment -->
                            <div>
                                <label for="edit-tx-comment" class="block text-sm font-medium mb-1">Ú©Ø§Ù…Ù†Øª / ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
                                <textarea id="edit-tx-comment" name="comment" rows="2" class="form-input-mobile w-full p-2 text-sm sm:text-base rounded-lg bg-gray-700 border border-gray-600 text-white focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                        </div>

                        <div id="edit-message" class="text-sm mt-3 hidden"></div>

                        <div class="mt-6 flex justify-end space-x-3 space-x-reverse">
                            <button type="button" data-close-modal="edit-modal" class="py-2 px-4 rounded-lg text-gray-400 hover:text-white transition duration-200">Ù„ØºÙˆ</button>
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. Comparison Modal -->
    <div id="comparison-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden transition-opacity flex items-center justify-center p-2 sm:p-4 modal-fade">
        <div class="modal-container">
            <div class="comparison-modal-content card p-4 sm:p-6 rounded-xl shadow-2xl transition-transform duration-300 transform scale-100 modal-slide">
                <div class="flex justify-between items-center mb-4 sm:mb-6">
                    <h3 class="text-lg sm:text-xl font-bold text-white">ğŸ“Š ØªØ­Ù„ÛŒÙ„ Ø§Ø±Ø²Ø´ Ù¾ÙˆØ±ØªÙÙˆ</h3>
                    <button type="button" data-close-modal="comparison-modal" class="text-gray-400 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="modal-scroll">
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4 mb-4 sm:mb-6">
                        <div class="p-3 sm:p-4 bg-gray-800 rounded-lg">
                            <p class="text-xs sm:text-sm text-gray-400">Ø§Ø±Ø²Ø´ ÙØ¹Ù„ÛŒ (ØªÙˆÙ…Ø§Ù†)</p>
                            <p id="current-value" class="text-lg sm:text-2xl font-bold text-white mt-1">-</p>
                        </div>
                        <div class="p-3 sm:p-4 bg-gray-800 rounded-lg">
                            <p class="text-xs sm:text-sm text-gray-400">Ù…Ø¹Ø§Ø¯Ù„ Ø¯Ù„Ø§Ø±</p>
                            <p id="current-usd" class="text-lg sm:text-2xl font-bold text-white mt-1">-</p>
                            <p id="usd-change" class="text-xs sm:text-sm mt-1"></p>
                        </div>
                        <div class="p-3 sm:p-4 bg-gray-800 rounded-lg">
                            <p class="text-xs sm:text-sm text-gray-400">Ù…Ø¹Ø§Ø¯Ù„ Ø·Ù„Ø§ (Ú¯Ø±Ù…)</p>
                            <p id="current-gold" class="text-lg sm:text-2xl font-bold text-white mt-1">-</p>
                            <p id="gold-change" class="text-xs sm:text-sm mt-1"></p>
                        </div>
                    </div>
                    
                    <!-- Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 mb-4 sm:mb-6">
                        <div>
                            <h4 class="text-sm sm:text-lg font-medium mb-2 sm:mb-3 text-gray-200">Ø§Ø±Ø²Ø´ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ù„Ø§Ø±</h4>
                            <div class="h-48 sm:h-64">
                                <canvas id="usdChart"></canvas>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-sm sm:text-lg font-medium mb-2 sm:mb-3 text-gray-200">Ø§Ø±Ø²Ø´ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø·Ù„Ø§</h4>
                            <div class="h-48 sm:h-64">
                                <canvas id="goldChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Table -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-700 text-xs sm:text-sm">
                            <thead class="sticky top-0 bg-gray-800">
                                <tr class="text-gray-400 uppercase tracking-wider">
                                    <th class="px-2 py-1 sm:px-3 sm:py-2 text-right">ØªØ§Ø±ÛŒØ®</th>
                                    <th class="px-2 py-1 sm:px-3 sm:py-2 text-right">Ø§Ø±Ø²Ø´ Ú©Ù„</th>
                                    <th class="px-2 py-1 sm:px-3 sm:py-2 text-right">Ù‚ÛŒÙ…Øª Ø¯Ù„Ø§Ø±</th>
                                    <th class="px-2 py-1 sm:px-3 sm:py-2 text-right">Ù‚ÛŒÙ…Øª Ø·Ù„Ø§</th>
                                    <th class="px-2 py-1 sm:px-3 sm:py-2 text-right">Ù…Ø¹Ø§Ø¯Ù„ Ø¯Ù„Ø§Ø±</th>
                                    <th class="px-2 py-1 sm:px-3 sm:py-2 text-right">Ù…Ø¹Ø§Ø¯Ù„ Ø·Ù„Ø§</th>
                                </tr>
                            </thead>
                            <tbody id="comparison-table-body" class="divide-y divide-gray-800">
                                <tr><td colspan="6" class="py-4 text-center text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Global Variables ---
        let allPrices = {};
        let allAssets = [];
        let portfolioChart = null;
        let usdChart = null;
        let goldChart = null;
        let purchaseMode = 'balance'; // 'balance' or 'portfolio'

        // --- Helper Functions ---

        /**
         * Formats a number with Toman separator and adds the Toman suffix.
         * @param {string|number} numberString 
         */
        const formatToman = (numberString) => {
            if (!numberString) return '0';
            const number = parseFloat(numberString);
            if (isNaN(number)) return '-';

            const formatted = number.toLocaleString('fa-IR', {
                minimumFractionDigits: 0,
                maximumFractionDigits: number < 1000 ? 2 : 0 
            });
            return `${formatted} Øª`;
        };
        
        /**
         * Formats a percentage value.
         * @param {string|number} numberString 
         */
        const formatPercent = (numberString) => {
            if (!numberString) return '0.00%';
            const number = parseFloat(numberString);
            if (isNaN(number)) return '-';
            const sign = number >= 0 ? '+' : '';
            return `${sign}${number.toFixed(2)}%`;
        };

        const formatPrice = (price) => {
            return parseFloat(price).toLocaleString('fa-IR', { minimumFractionDigits: 0, maximumFractionDigits: 4 });
        };

        const getStatusColor = (value) => {
            const num = parseFloat(value);
            return num >= 0 ? 'success' : 'danger';
        };

        const formatPersianDate = (dateString) => {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('fa-IR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return dateString;
            }
        };

        // --- API & Data Fetching ---

        const fetchPrices = async () => {
            try {
                const response = await fetch('/api/prices');
                if (!response.ok) throw new Error('Failed to fetch prices');
                allPrices = await response.json();
                renderPricesSidebar(allPrices);
                updateWalletBalanceDisplay();
                updatePurchasePowerBox();
            } catch (error) {
                console.error('Error fetching prices:', error);
                document.getElementById('last-updated').textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§';
            }
        };

        const fetchAssets = async () => {
            try {
                const response = await fetch('/api/assets');
                if (!response.ok) throw new Error('Failed to fetch assets');
                allAssets = await response.json();
                renderAssetsDashboard(allAssets);
                renderPricesSidebar(allPrices);
                updateWalletBalanceDisplay();
                updatePurchasePowerBox();
                updateDailyProfit();
            } catch (error) {
                console.error('Error fetching assets:', error);
                document.getElementById('assets-table-body').innerHTML = `<tr><td colspan="7" class="py-4 text-center text-red-400">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø±Ø§ÛŒÛŒâ€ŒÙ‡Ø§</td></tr>`;
            }
        };

        const fetchChartData = async () => {
            try {
                const response = await fetch('/api/chart-data');
                if (!response.ok) throw new Error('Failed to fetch chart data');
                const data = await response.json();
                renderChart(data);
            } catch (error) {
                console.error('Error fetching chart data:', error);
            }
        };

        // --- Daily Profit Functions ---
        // ---------------------------
        // --- Daily Profit Functions ---
const updateDailyProfit = async () => {
    try {
        const response = await fetch('/api/today-profit');
        if (!response.ok) throw new Error('Failed to fetch daily profit');
        const data = await response.json();
        
        if (data.error) {
            console.error('Daily profit error:', data.error);
            return;
        }
        
        // Update daily profit display
        const dailyChange = data.daily_change || 0;
        const dailyPercent = data.daily_change_percent || 0;
        const yesterdayValue = data.yesterday_value || (data.total_value - data.daily_change);
        
        document.getElementById('daily-profit-toman').textContent = formatToman(dailyChange);
        document.getElementById('daily-profit-percent').textContent = formatPercent(dailyPercent);
        document.getElementById('yesterday-value').textContent = formatToman(yesterdayValue);
        
        // Add color classes
        const dailyTomanEl = document.getElementById('daily-profit-toman');
        const dailyPercentEl = document.getElementById('daily-profit-percent');
        
        if (dailyChange >= 0) {
            dailyTomanEl.classList.remove('text-red-400');
            dailyTomanEl.classList.add('text-green-400');
            dailyPercentEl.classList.remove('text-red-400');
            dailyPercentEl.classList.add('text-green-400');
        } else {
            dailyTomanEl.classList.remove('text-green-400');
            dailyTomanEl.classList.add('text-red-400');
            dailyPercentEl.classList.remove('text-green-400');
            dailyPercentEl.classList.add('text-red-400');
        }
        
        // Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯ÛŒØ¨Ø§Ú¯ Ø¯Ø± Ú©Ù†Ø³ÙˆÙ„
        console.log('Daily Profit Data:', {
            today: data.total_value,
            yesterday: yesterdayValue,
            change: dailyChange,
            percent: dailyPercent
        });
        
    } catch (error) {
        console.error('Error updating daily profit:', error);
        document.getElementById('daily-profit-toman').textContent = 'Ø®Ø·Ø§';
        document.getElementById('daily-profit-percent').textContent = 'Ø®Ø·Ø§';
        document.getElementById('yesterday-value').textContent = 'Ø®Ø·Ø§';
    }
};
        // ------------------
        // --- Purchase Power Mode Toggle ---
        document.getElementById('purchase-mode-balance').addEventListener('click', () => {
            if (purchaseMode !== 'balance') {
                purchaseMode = 'balance';
                updatePurchaseModeUI();
                updatePurchasePowerBox();
            }
        });

        document.getElementById('purchase-mode-portfolio').addEventListener('click', () => {
            if (purchaseMode !== 'portfolio') {
                purchaseMode = 'portfolio';
                updatePurchaseModeUI();
                updatePurchasePowerBox();
            }
        });

        const updatePurchaseModeUI = () => {
            const balanceBtn = document.getElementById('purchase-mode-balance');
            const portfolioBtn = document.getElementById('purchase-mode-portfolio');
            const infoText = document.getElementById('purchase-power-info');
            
            if (purchaseMode === 'balance') {
                balanceBtn.classList.add('bg-blue-600', 'text-white');
                balanceBtn.classList.remove('text-gray-300', 'bg-gray-700');
                portfolioBtn.classList.remove('bg-blue-600', 'text-white');
                portfolioBtn.classList.add('text-gray-300', 'bg-gray-700');
                infoText.textContent = 'Ø¨Ø§ Ú©Ù„ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø±ÛŒØ§Ù„ÛŒ';
            } else {
                portfolioBtn.classList.add('bg-blue-600', 'text-white');
                portfolioBtn.classList.remove('text-gray-300', 'bg-gray-700');
                balanceBtn.classList.remove('bg-blue-600', 'text-white');
                balanceBtn.classList.add('text-gray-300', 'bg-gray-700');
                infoText.textContent = 'Ø¨Ø§ Ú©Ù„ Ø§Ø±Ø²Ø´ Ù¾ÙˆØ±ØªÙÙˆÛŒ';
            }
        };

        // --- Updated Purchase Power Calculation ---
        const updatePurchasePowerBox = () => {
            let availableBalance = 0;
            
            if (purchaseMode === 'balance') {
                // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø±ÛŒØ§Ù„ÛŒ
                const rialAsset = allAssets.find(a => a.symbol === 'RIAL_WALLET');
                availableBalance = rialAsset ? parseFloat(rialAsset.total_quantity) : 0;
            } else {
                // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú©Ù„ Ø§Ø±Ø²Ø´ Ù¾ÙˆØ±ØªÙÙˆ
                let totalPortfolioValue = 0;
                allAssets.forEach(asset => {
                    if (asset.symbol === 'RIAL_WALLET') {
                        totalPortfolioValue += parseFloat(asset.total_quantity);
                    } else {
                        totalPortfolioValue += parseFloat(asset.current_value) || 0;
                    }
                });
                availableBalance = totalPortfolioValue;
            }
            
            if (availableBalance <= 0 || !allPrices) {
                document.getElementById('usd-amount').textContent = '-';
                document.getElementById('gold-amount').textContent = '-';
                document.getElementById('btc-amount').textContent = '-';
                return;
            }
            
            // Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ¹Ø¯Ø§Ø¯ Ø¯Ù„Ø§Ø±ØŒ Ø·Ù„Ø§ Ùˆ Ø¨ÛŒØªâ€ŒÚ©ÙˆÛŒÙ† Ù‚Ø§Ø¨Ù„ Ø®Ø±ÛŒØ¯
            let usdPrice = 0;
            let goldPrice = 0;
            let btcPrice = 0;
            
            // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§
            for (const category in allPrices) {
                if (allPrices[category]) {
                    allPrices[category].forEach(item => {
                        if (item.symbol === 'USD') usdPrice = item.toman_price;
                        if (item.symbol === 'GOL18') goldPrice = item.toman_price;
                        if (item.symbol === 'BITCOIN') btcPrice = item.toman_price;
                    });
                }
            }
            
            // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ±
            if (usdPrice > 0) {
                const usdAmount = availableBalance / usdPrice;
                document.getElementById('usd-amount').textContent = usdAmount.toFixed(2);
                document.getElementById('usd-purchase').textContent = `Ù‚ÛŒÙ…Øª: ${formatToman(usdPrice)}`;
            } else {
                document.getElementById('usd-amount').textContent = '-';
                document.getElementById('usd-purchase').textContent = 'Ù‚ÛŒÙ…Øª Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª';
            }
            
            if (goldPrice > 0) {
                const goldAmount = availableBalance / goldPrice;
                document.getElementById('gold-amount').textContent = goldAmount.toFixed(3);
                document.getElementById('gold-purchase').textContent = `Ù‚ÛŒÙ…Øª: ${formatToman(goldPrice)}`;
            } else {
                document.getElementById('gold-amount').textContent = '-';
                document.getElementById('gold-purchase').textContent = 'Ù‚ÛŒÙ…Øª Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª';
            }
            
            if (btcPrice > 0) {
                const btcAmount = availableBalance / btcPrice;
                document.getElementById('btc-amount').textContent = btcAmount.toFixed(6);
                document.getElementById('btc-purchase').textContent = `Ù‚ÛŒÙ…Øª: ${formatToman(btcPrice)}`;
            } else {
                document.getElementById('btc-amount').textContent = '-';
                document.getElementById('btc-purchase').textContent = 'Ù‚ÛŒÙ…Øª Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª';
            }
        };

        // --- ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø±ÙˆØ²Ø§Ù†Ù‡ ---
        const showDailyHistory = async () => {
            try {
                const response = await fetch('/api/daily-profit');
                if (!response.ok) throw new Error('Failed to fetch daily history');
                const data = await response.json();
                
                // Ø³Ø§Ø®Øª HTML Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ®Ú†Ù‡
                let html = '<div class="space-y-3">';
                
                // Ù†Ù…Ø§ÛŒØ´ 10 Ø±ÙˆØ² Ø¢Ø®Ø±
                const recentData = data.slice(-10).reverse();
                
                recentData.forEach(entry => {
                    const date = new Date(entry.date).toLocaleDateString('fa-IR');
                    const isPositive = entry.daily_change >= 0;
                    const changeColor = isPositive ? 'text-green-400' : 'text-red-400';
                    const changeIcon = isPositive ? 'ğŸ“ˆ' : 'ğŸ“‰';
                    
                    html += `
                        <div class="p-3 bg-gray-800 rounded-lg">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium text-gray-300">${date}</span>
                                <span class="text-xs ${changeColor}">${changeIcon} ${formatPercent(entry.daily_change_percent)}</span>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-xs">
                                <div>
                                    <span class="text-gray-500">Ø§Ø±Ø²Ø´ Ú©Ù„:</span>
                                    <span class="font-mono text-gray-300 mr-1">${formatToman(entry.total_value)}</span>
                                </div>
                                <div>
                                    <span class="text-gray-500">ØªØºÛŒÛŒØ± Ø±ÙˆØ²:</span>
                                    <span class="font-mono ${changeColor} mr-1">${formatToman(entry.daily_change)}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                // Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ù…ÙˆØ¯Ø§Ù„
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4 modal-fade';
                modal.innerHTML = `
                    <div class="modal-content card p-4 sm:p-6 rounded-xl shadow-2xl modal-slide max-w-lg w-full max-h-[80vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-white">ğŸ“Š ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø±ÙˆØ²Ø§Ù†Ù‡</h3>
                            <button type="button" onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-white">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="text-sm text-gray-400 mb-3">
                            Ù†Ù…Ø§ÛŒØ´ 10 Ø±ÙˆØ² Ø§Ø®ÛŒØ±
                        </div>
                        ${html}
                        <div class="mt-6 flex justify-end">
                            <button type="button" onclick="this.parentElement.parentElement.remove()" class="py-2 px-4 rounded-lg bg-gray-600 hover:bg-gray-700 text-white transition duration-200">
                                Ø¨Ø³ØªÙ†
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('Error showing daily history:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¹Ù…Ù„Ú©Ø±Ø¯');
            }
        };

        // --- Rendering Logic ---

        const renderPricesSidebar = (prices) => {
            const now = new Date();
            document.getElementById('last-updated').textContent = `Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ${now.toLocaleTimeString('fa-IR')}`;
            
            // Û±. Ù†Ù…Ø§ÛŒØ´ Ù‚ÛŒÙ…Øª Ø¯Ø§Ø±Ø§ÛŒÛŒâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø± Ù¾ÙˆØ±ØªÙÙˆ
            const portfolioPricesList = document.getElementById('portfolio-prices-list');
            portfolioPricesList.innerHTML = '';
            
            // Ø¯Ø§Ø±Ø§ÛŒÛŒâ€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø¯Ø± Ù¾ÙˆØ±ØªÙÙˆ Ø¯Ø§Ø±ÛŒÙ… (Ø¯Ø§Ø±Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ > 0)
            const portfolioAssets = allAssets.filter(asset => {
                if (asset.symbol === 'RIAL_WALLET') return false;
                return parseFloat(asset.total_quantity) > 0;
            });
            
            if (portfolioAssets.length > 0) {
                portfolioAssets.forEach(asset => {
                    const currentPrice = parseFloat(asset.current_price);
                    if (currentPrice > 0) {
                        portfolioPricesList.innerHTML += `
                            <div class="flex justify-between items-center py-1 px-2 hover:bg-gray-800 rounded">
                                <div class="text-right">
                                    <span class="text-gray-300 text-sm">${asset.title}</span>
                                    <span class="text-gray-500 text-xs block">(${asset.symbol})</span>
                                </div>
                                <span class="font-mono text-white text-sm">${formatToman(currentPrice)}</span>
                            </div>
                        `;
                    }
                });
            } else {
                portfolioPricesList.innerHTML = '<p class="text-gray-500 text-sm text-center py-2">Ù‡Ù†ÙˆØ² Ø¯Ø§Ø±Ø§ÛŒÛŒâ€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</p>';
            }
            
            // Û². Ù¾Ø± Ú©Ø±Ø¯Ù† Ú©Ø´ÙˆÛŒÛŒâ€ŒÙ‡Ø§
            const categories = [
                { id: 'gold_coin', title: 'Ø·Ù„Ø§ Ùˆ Ø³Ú©Ù‡' },
                { id: 'currency', title: 'Ø§Ø±Ø²' },
                { id: 'crypto', title: 'Ø§Ø±Ø² Ø¯ÛŒØ¬ÛŒØªØ§Ù„' }
            ];
            
            categories.forEach(category => {
                const container = document.getElementById(`${category.id}-prices`);
                if (!container) return;
                
                container.innerHTML = '';
                
                if (prices[category.id] && prices[category.id].length > 0) {
                    // Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† ØªØ¹Ø¯Ø§Ø¯ Ù†Ù…Ø§ÛŒØ´
                    const itemsToShow = prices[category.id].slice(0, 8);
                    
                    itemsToShow.forEach(item => {
                        const priceDisplay = formatToman(item.toman_price);
                        let subText = '';
                        if (category.id === 'crypto' && item.usd_price) {
                            subText = `($${parseFloat(item.usd_price).toFixed(3)})`;
                        }
                        
                        container.innerHTML += `
                            <div class="flex justify-between items-center py-1 px-1 hover:bg-gray-800 rounded">
                                <span class="text-gray-300 text-sm truncate max-w-[60%]">${item.title}</span>
                                <div class="text-left">
                                    <span class="font-mono text-white text-sm">${priceDisplay}</span>
                                    ${subText ? `<span class="text-xs text-gray-500 block">${subText}</span>` : ''}
                                </div>
                            </div>
                        `;
                    });
                    
                    // Ø§Ú¯Ø± Ø¢ÛŒØªÙ… Ø¨ÛŒØ´ØªØ±ÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ù‡
                    if (prices[category.id].length > 8) {
                        container.innerHTML += `
                            <div class="text-center pt-2 border-t border-gray-800">
                                <span class="text-gray-500 text-xs">Ùˆ ${prices[category.id].length - 8} Ù…ÙˆØ±Ø¯ Ø¯ÛŒÚ¯Ø±</span>
                            </div>
                        `;
                    }
                } else {
                    container.innerHTML = '<p class="text-gray-500 text-sm text-center py-2">Ù‚ÛŒÙ…ØªÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</p>';
                }
            });
        };
        // -**-*
        const renderAssetsDashboard = (assets) => {
    const tableBody = document.getElementById('assets-table-body');
    tableBody.innerHTML = '';
    
    let totalValue = 0;
    let totalProfit = 0;
    let totalCostBasis = 0;
    let rialWalletBalance = 0;

    assets.forEach(asset => {
        const quantity = parseFloat(asset.total_quantity);
        const costBasis = parseFloat(asset.cost_basis);
        const currentValue = parseFloat(asset.current_value);
        const profitLoss = parseFloat(asset.profit_loss);
        const returnPct = parseFloat(asset.return_pct);

        if (asset.symbol === 'RIAL_WALLET') {
            rialWalletBalance = quantity;
            totalValue += quantity;
            return;
        }

        if (quantity > 0) {
            totalValue += currentValue;
            totalProfit += profitLoss;
            totalCostBasis += costBasis;

            const statusClass = getStatusColor(profitLoss);
            
            tableBody.innerHTML += `
                <tr class="hover:bg-gray-800 transition duration-150">
                    <td class="px-2 py-2 sm:px-3 sm:py-3 font-medium text-white text-xs sm:text-sm">
                        <div class="flex flex-col">
                            <span>${asset.title}</span>
                            <span class="text-gray-500 text-xs">(${asset.symbol})</span>
                        </div>
                    </td>
                    <td class="px-2 py-2 sm:px-3 sm:py-3 font-mono text-xs sm:text-sm">${formatToman(asset.break_even_price)}</td>
                    <td class="px-2 py-2 sm:px-3 sm:py-3 font-mono text-xs sm:text-sm">${formatToman(asset.current_price)}</td>
                    <td class="px-2 py-2 sm:px-3 sm:py-3 font-mono text-xs sm:text-sm">${formatPrice(asset.total_quantity)}</td>
                    <td class="px-2 py-2 sm:px-3 sm:py-3 font-mono text-xs sm:text-sm">${formatToman(asset.current_value)}</td>
                    <td class="px-2 py-2 sm:px-3 sm:py-3 text-xs sm:text-sm ${statusClass} font-semibold">
                        ${formatToman(profitLoss)} 
                        <span class="text-xs">(${formatPercent(returnPct)})</span>
                    </td>
                    <td class="px-2 py-2 sm:px-3 sm:py-3 text-center">
                        <button onclick="openHistoryModal('${asset.title}', '${asset.id}')" class="text-blue-500 hover:text-blue-400 text-xs sm:text-sm action-btn">Ù…Ø´Ø§Ù‡Ø¯Ù‡</button>
                    </td>
                </tr>
            `;
        }
    });

    // Handle empty assets case
    if (tableBody.innerHTML === '') {
        tableBody.innerHTML = `<tr><td colspan="7" class="py-4 text-center text-gray-500">Ù‡Ù†ÙˆØ² Ø¯Ø§Ø±Ø§ÛŒÛŒ Ø§Ø³Ù¾Ø§ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</td></tr>`;
    }

    // --- Update Summary Cards ---
    const overallReturnPct = totalCostBasis > 0 ? (totalProfit / totalCostBasis) * 100 : 0;
    const overallStatusClass = getStatusColor(totalProfit);

    // Update Total Value (Asset Value + Rial Wallet)
    document.getElementById('total-value').textContent = formatToman(totalValue);
    
    // Update Total Profit/Loss (Only from Non-Wallet Assets)
    document.getElementById('total-profit').textContent = formatToman(totalProfit);
    document.getElementById('total-profit-pct').className = `text-sm mt-1 flex items-center ${overallStatusClass} font-medium`;
    document.getElementById('total-profit-pct').innerHTML = `<svg class="w-4 h-4 ml-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="${totalProfit >= 0 ? 'M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z' : 'M14.707 7.293a1 1 0 00-1.414 0L10 10.586l-3.293-3.293a1 1 0 00-1.414 1.414l4 4a1 1 0 001.414 0l4-4a1 1 0 000-1.414z'}" clip-rule="evenodd"></path></svg>${formatPercent(overallReturnPct)}`;
    
    // Update Rial Wallet Balance
    document.getElementById('rial-wallet-balance').textContent = formatToman(rialWalletBalance);
};
        // -*-*
        const renderChart = (data) => {
            const dates = Object.keys(data).sort();
            const values = dates.map(date => data[date]);

            const ctx = document.getElementById('portfolioChart').getContext('2d');
            
            if (portfolioChart) {
                portfolioChart.destroy();
            }

            portfolioChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Ø§Ø±Ø²Ø´ Ú©Ù„ Ù¾ÙˆØ±ØªÙÙˆÛŒ',
                        data: values,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        fill: 'origin',
                        tension: 0.2,
                        pointRadius: 3,
                        pointBackgroundColor: '#3b82f6',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    color: '#c9d1d9',
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'day', tooltipFormat: 'yyyy-MM-dd' },
                            title: { display: true, text: 'ØªØ§Ø±ÛŒØ®', color: '#8b949e' },
                            ticks: { color: '#8b949e', maxRotation: 0 },
                            grid: { color: '#30363d' }
                        },
                        y: {
                            title: { display: true, text: 'Ø§Ø±Ø²Ø´ (ØªÙˆÙ…Ø§Ù†)', color: '#8b949e' },
                            ticks: {
                                color: '#8b949e',
                                callback: function(value) { return formatToman(value).replace('Øª', ''); }
                            },
                            grid: { color: '#30363d' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) { return ` ${context.dataset.label}: ${formatToman(context.parsed.y)}`; }
                            },
                            rtl: true
                        }
                    }
                }
            });
        };

        // --- Wallet Balance Display ---

        const updateWalletBalanceDisplay = () => {
            const rialAsset = allAssets.find(a => a.symbol === 'RIAL_WALLET');
            const balance = rialAsset ? parseFloat(rialAsset.total_quantity) : 0;
            
            const walletDisplay = document.getElementById('wallet-balance-display');
            const currentBalance = document.getElementById('current-wallet-balance');
            const purchasePower = document.getElementById('purchase-power-info-modal');
            
            currentBalance.textContent = formatToman(balance);
            
            // Ø§Ú¯Ø± Ù†ÙˆØ¹ ØªØ±Ø§Ú©Ù†Ø´ Ø®Ø±ÛŒØ¯ Ù‡Ø³ØªØŒ Ù‚Ø¯Ø±Øª Ø®Ø±ÛŒØ¯ Ø±Ùˆ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©Ù†
            const txType = document.getElementById('tx-type').value;
            const assetSymbol = document.getElementById('asset-name').value;
            
            if (txType === 'buy' && assetSymbol && allPrices) {
                // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù‚ÛŒÙ…Øª Ø¯Ø§Ø±Ø§ÛŒÛŒ
                let assetPrice = 0;
                for (const category in allPrices) {
                    const asset = allPrices[category].find(a => a.symbol === assetSymbol);
                    if (asset) {
                        assetPrice = asset.toman_price;
                        break;
                    }
                }
                
                if (assetPrice > 0 && balance > 0) {
                    const maxQuantity = balance / assetPrice;
                    purchasePower.textContent = `Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø­Ø¯Ø§Ú©Ø«Ø± ${formatPrice(maxQuantity)} ÙˆØ§Ø­Ø¯ Ø®Ø±ÛŒØ¯Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯`;
                    walletDisplay.classList.remove('hidden');
                } else {
                    purchasePower.textContent = 'Ù…ÙˆØ¬ÙˆØ¯ÛŒ ÛŒØ§ Ù‚ÛŒÙ…Øª Ø¯Ø§Ø±Ø§ÛŒÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª';
                    walletDisplay.classList.remove('hidden');
                }
            } else if (txType === 'buy') {
                purchasePower.textContent = 'Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚Ø¯Ø±Øª Ø®Ø±ÛŒØ¯ØŒ Ø§Ø¨ØªØ¯Ø§ Ø¯Ø§Ø±Ø§ÛŒÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯';
                walletDisplay.classList.remove('hidden');
            } else {
                walletDisplay.classList.add('hidden');
            }
        };

        // --- Modals and Forms ---

        const updateTransactionFormVisibility = (txType) => {
            const isWalletTx = txType === 'deposit' || txType === 'withdrawal';
            const isNonWalletTx = txType === 'buy' || txType === 'sell' || txType === 'save_profit';
            
            document.getElementById('asset-type-group').classList.toggle('hidden', isWalletTx);
            document.getElementById('asset-name-group').classList.toggle('hidden', isWalletTx);
            document.getElementById('price-per-unit-group').classList.toggle('hidden', isWalletTx || txType === '');
            document.getElementById('category-group').classList.toggle('hidden', isWalletTx);

            const quantityLabel = document.getElementById('quantity-label');
            
            if (txType === 'deposit' || txType === 'withdrawal') {
                document.getElementById('asset-name').value = 'RIAL_WALLET';
                document.getElementById('asset-name').name = 'symbol';
                document.getElementById('asset-name').required = true;
                
                quantityLabel.textContent = (txType === 'deposit' ? 'Ù…Ù‚Ø¯Ø§Ø± ÙˆØ§Ø±ÛŒØ² (ØªÙˆÙ…Ø§Ù†)' : 'Ù…Ù‚Ø¯Ø§Ø± Ø¨Ø±Ø¯Ø§Ø´Øª (ØªÙˆÙ…Ø§Ù†)');
                document.getElementById('tx-price').required = false;
                document.getElementById('tx-price').value = '1';

            } else if (isNonWalletTx) {
                document.getElementById('asset-name').name = 'symbol';
                document.getElementById('asset-name').required = true;
                quantityLabel.textContent = 'Ù…Ù‚Ø¯Ø§Ø±';
                document.getElementById('tx-price').required = true;
            }
            
            // Update wallet display
            updateWalletBalanceDisplay();
        };

        document.getElementById('tx-type').addEventListener('change', (e) => {
            updateTransactionFormVisibility(e.target.value);
            // Reset asset type/name for clarity
            document.getElementById('asset-type').value = '';
            document.getElementById('asset-name').innerHTML = '<option value="">...</option>';
            document.getElementById('asset-name').disabled = true;
        });

        document.getElementById('add-transaction-btn').addEventListener('click', () => {
            // Reset form for new transaction
            document.getElementById('transaction-form').reset();
            document.getElementById('tx-message').classList.add('hidden');
            document.getElementById('tx-date').value = ''; // Reset date to today
            document.getElementById('tx-type').dispatchEvent(new Event('change')); // Reset visibility
            document.getElementById('transaction-modal').classList.remove('hidden');
        });
        
        // Reset date button
        document.getElementById('reset-date').addEventListener('click', () => {
            document.getElementById('tx-date').value = '';
        });

        document.querySelectorAll('[data-close-modal]').forEach(btn => btn.addEventListener('click', () => {
            document.getElementById(btn.dataset.closeModal).classList.add('hidden');
        }));

        // Close modal when clicking outside
        document.querySelectorAll('.fixed.inset-0').forEach(modal => {
            modal.addEventListener('click', (e) => { 
                if (e.target === modal) modal.classList.add('hidden'); 
            });
        });

        const openWalletModal = () => {
            const rialAsset = allAssets.find(a => a.symbol === 'RIAL_WALLET');
            const balance = rialAsset ? parseFloat(rialAsset.total_quantity) : 0;
            document.getElementById('wallet-current-balance').textContent = `Ù…ÙˆØ¬ÙˆØ¯ÛŒ: ${formatToman(balance)}`;
            document.getElementById('wallet-modal').classList.remove('hidden');
        };

        const openHistoryModal = (assetTitle, assetId) => {
            const asset = allAssets.find(a => a.id === assetId);
            if (!asset) return;

            document.getElementById('history-title').textContent = `ØªØ§Ø±ÛŒØ®Ú†Ù‡ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ ${assetTitle}`;
            const tableBody = document.getElementById('history-table-body');
            tableBody.innerHTML = '';

            asset.transactions.forEach(tx => {
                const date = formatPersianDate(tx.date);
                const quantity = parseFloat(tx.quantity);
                const pricePerUnit = tx.price_per_unit ? formatToman(tx.price_per_unit) : '-';
                
                let txTypeDisplay = '';
                if (tx.type === 'buy') txTypeDisplay = `<span class="text-green-400">Ø®Ø±ÛŒØ¯</span>`;
                else if (tx.type === 'sell') txTypeDisplay = `<span class="text-red-400">ÙØ±ÙˆØ´</span>`;
                else if (tx.type === 'save_profit') txTypeDisplay = `<span class="text-yellow-400">Ø³ÛŒÙˆ Ø³ÙˆØ¯</span>`;
                else if (tx.type === 'deposit') txTypeDisplay = `<span class="text-green-500">ÙˆØ§Ø±ÛŒØ²</span>`;
                else if (tx.type === 'withdrawal') txTypeDisplay = `<span class="text-red-500">Ø¨Ø±Ø¯Ø§Ø´Øª</span>`;
                
                tableBody.innerHTML += `
                    <tr class="hover:bg-gray-800 transition duration-150">
                        <td class="px-2 py-1 sm:px-3 sm:py-2 text-xs">${date}</td>
                        <td class="px-2 py-1 sm:px-3 sm:py-2 text-right">
                            <div class="flex flex-col items-end">
                                ${txTypeDisplay}
                                <span class="text-gray-500 text-xs mt-1">${tx.category || '-'}</span>
                            </div>
                        </td>
                        <td class="px-2 py-1 sm:px-3 sm:py-2 font-mono text-xs sm:text-sm">${formatPrice(quantity)}</td>
                        <td class="px-2 py-1 sm:px-3 sm:py-2 font-mono text-xs sm:text-sm">${pricePerUnit}</td>
                        <td class="px-2 py-1 sm:px-3 sm:py-2 text-xs text-gray-400 max-w-[150px] sm:max-w-xs truncate" title="${tx.comment || '-'}">${tx.comment || '-'}</td>
                        <td class="px-2 py-1 sm:px-3 sm:py-2 text-center">
                            <div class="flex justify-center space-x-2 space-x-reverse">
                                <button onclick="openEditModal('${tx.transaction_id}', '${assetId}')" class="text-blue-500 hover:text-blue-400 text-xs sm:text-sm action-btn">ÙˆÛŒØ±Ø§ÛŒØ´</button>
                                <button onclick="deleteTransaction('${tx.transaction_id}')" class="text-red-500 hover:text-red-400 text-xs sm:text-sm action-btn">Ø­Ø°Ù</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            document.getElementById('history-modal').classList.remove('hidden');
        };

        // --- Edit Transaction Functions ---

        const openEditModal = (transactionId, assetId) => {
            const asset = allAssets.find(a => a.id === assetId);
            if (!asset) return;
            
            const transaction = asset.transactions.find(tx => tx.transaction_id === transactionId);
            if (!transaction) return;
            
            // Ù¾Ø± Ú©Ø±Ø¯Ù† ÙØ±Ù…
            document.getElementById('edit-transaction-id').value = transactionId;
            document.getElementById('edit-asset-id').value = assetId;
            document.getElementById('edit-tx-type').value = transaction.type;
            document.getElementById('edit-asset-name').textContent = `${asset.title} (${asset.symbol})`;
            document.getElementById('edit-tx-category').value = transaction.category || '';
            document.getElementById('edit-tx-quantity').value = transaction.quantity;
            document.getElementById('edit-tx-price').value = transaction.price_per_unit || '';
            document.getElementById('edit-tx-comment').value = transaction.comment || '';
            
            // Set date
            const txDate = new Date(transaction.date);
            document.getElementById('edit-tx-date').value = txDate.toISOString().split('T')[0];
            
            // ØªÙ†Ø¸ÛŒÙ… visibility
            const isPriceVisible = ['buy', 'sell', 'save_profit'].includes(transaction.type);
            document.getElementById('edit-price-per-unit-group').classList.toggle('hidden', !isPriceVisible);
            
            // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…ÙˆØ¯Ø§Ù„
            document.getElementById('edit-modal').classList.remove('hidden');
        };

        // Ø§Ø±Ø³Ø§Ù„ ÙØ±Ù… ÙˆÛŒØ±Ø§ÛŒØ´
        document.getElementById('edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const messageEl = document.getElementById('edit-message');
            messageEl.classList.add('hidden');
            
            const transactionId = document.getElementById('edit-transaction-id').value;
            const data = {
                type: document.getElementById('edit-tx-type').value,
                date: document.getElementById('edit-tx-date').value ? 
                    new Date(document.getElementById('edit-tx-date').value + 'T12:00:00Z').toISOString() : 
                    null,
                category: document.getElementById('edit-tx-category').value,
                quantity: parseFloat(document.getElementById('edit-tx-quantity').value),
                price_per_unit: document.getElementById('edit-tx-price').value ? 
                    parseFloat(document.getElementById('edit-tx-price').value) : null,
                comment: document.getElementById('edit-tx-comment').value
            };
            
            try {
                const response = await fetch(`/api/transactions/${transactionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    messageEl.textContent = 'ØªØ±Ø§Ú©Ù†Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯.';
                    messageEl.classList.remove('danger');
                    messageEl.classList.add('success');
                    
                    // Reload data
                    await fetchAssets();
                    await fetchChartData();
                    
                    // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²
                    document.getElementById('edit-modal').classList.add('hidden');
                    document.getElementById('history-modal').classList.add('hidden');
                    
                    setTimeout(() => {
                        messageEl.classList.add('hidden');
                    }, 2000);
                } else {
                    const error = await response.json();
                    messageEl.textContent = `Ø®Ø·Ø§ Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´ ØªØ±Ø§Ú©Ù†Ø´: ${error.error || response.statusText}`;
                    messageEl.classList.remove('success');
                    messageEl.classList.add('danger');
                }
            } catch (error) {
                console.error('Edit error:', error);
                messageEl.textContent = 'Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡ ÛŒØ§ Ø³Ø±ÙˆØ± Ø±Ø® Ø¯Ø§Ø¯.';
                messageEl.classList.remove('success');
                messageEl.classList.add('danger');
            }
            messageEl.classList.remove('hidden');
        });

        // Asset dropdown population
        document.getElementById('asset-type').addEventListener('change', () => { 
            const selectedType = document.getElementById('asset-type').value;
            const assetNameSelect = document.getElementById('asset-name');
            assetNameSelect.innerHTML = '<option value="">...</option>'; 
            assetNameSelect.disabled = true;
            if (selectedType && allPrices[selectedType]) {
                assetNameSelect.innerHTML = `<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>${allPrices[selectedType].map(a => `<option value="${a.symbol}" data-title="${a.title}">${a.title} (${a.symbol})</option>`).join('')}`;
                assetNameSelect.disabled = false;
            }
            updateWalletBalanceDisplay();
        });

        document.getElementById('asset-name').addEventListener('change', updateWalletBalanceDisplay);

        document.getElementById('transaction-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const messageEl = document.getElementById('tx-message');
            messageEl.classList.add('hidden');
            
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // Convert numbers
            data.quantity = parseFloat(data.quantity);
            if (data.price_per_unit) {
                data.price_per_unit = parseFloat(data.price_per_unit);
            }
            
            // Handle date
            if (!data.date) {
                data.date = new Date().toISOString();
            } else {
                data.date = new Date(data.date + 'T12:00:00Z').toISOString();
            }
            
            if (data.type === 'deposit' || data.type === 'withdrawal') {
                data.symbol = 'RIAL_WALLET';
                delete data.category;
                delete data.price_per_unit;
            }
            
            // Validation check
            if (data.quantity <= 0) {
                messageEl.textContent = 'Ù…Ù‚Ø¯Ø§Ø± Ø¨Ø§ÛŒØ¯ Ø¨Ø²Ø±Ú¯ØªØ± Ø§Ø² ØµÙØ± Ø¨Ø§Ø´Ø¯.';
                messageEl.classList.remove('hidden');
                messageEl.classList.add('danger');
                return;
            }

            // Check wallet balance for buy transactions
            if (data.type === 'buy' && data.symbol !== 'RIAL_WALLET') {
                const rialAsset = allAssets.find(a => a.symbol === 'RIAL_WALLET');
                if (rialAsset) {
                    const balance = parseFloat(rialAsset.total_quantity);
                    const totalCost = data.quantity * data.price_per_unit;
                    
                    if (totalCost > balance) {
                        messageEl.textContent = `Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª. Ù…ÙˆØ¬ÙˆØ¯ÛŒ: ${formatToman(balance)}ØŒ Ù…Ø¨Ù„Øº Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²: ${formatToman(totalCost)}`;
                        messageEl.classList.remove('success');
                        messageEl.classList.add('danger');
                        messageEl.classList.remove('hidden');
                        return;
                    }
                }
            }

            try {
                const response = await fetch('/api/transactions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    messageEl.textContent = 'ØªØ±Ø§Ú©Ù†Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯.';
                    messageEl.classList.remove('danger');
                    messageEl.classList.add('success');
                    form.reset();
                    document.getElementById('tx-type').dispatchEvent(new Event('change'));
                    
                    // Reload data
                    await fetchAssets();
                    await fetchChartData();
                    await updateDailyProfit();

                    // Close modal after a short delay
                    setTimeout(() => document.getElementById('transaction-modal').classList.add('hidden'), 1500);
                } else {
                    const error = await response.json();
                    messageEl.textContent = `Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´: ${error.error || response.statusText}`;
                    messageEl.classList.remove('success');
                    messageEl.classList.add('danger');
                }
            } catch (error) {
                console.error('Submit error:', error);
                messageEl.textContent = 'Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡ ÛŒØ§ Ø³Ø±ÙˆØ± Ø±Ø® Ø¯Ø§Ø¯.';
                messageEl.classList.remove('success');
                messageEl.classList.add('danger');
            }
            messageEl.classList.remove('hidden');
        });
        
        const deleteTransaction = async (id) => {
            const isConfirmed = window.confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† ØªØ±Ø§Ú©Ù†Ø´ Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª.');
            if (!isConfirmed) return;

            try {
                const response = await fetch(`/api/transactions/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    alert('ØªØ±Ø§Ú©Ù†Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯.');
                    document.getElementById('history-modal').classList.add('hidden');
                    // Reload data
                    await fetchAssets();
                    await fetchChartData();
                    await updateDailyProfit();
                } else {
                    const error = await response.json();
                    alert(`Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù ØªØ±Ø§Ú©Ù†Ø´: ${error.error || response.statusText}`);
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡ ÛŒØ§ Ø³Ø±ÙˆØ± Ø±Ø® Ø¯Ø§Ø¯.');
            }
        };

        // --- Comparison Modal Functions ---

        const openComparisonModal = async () => {
            try {
                const response = await fetch('/api/comparison-data');
                if (!response.ok) throw new Error('Failed to fetch comparison data');
                const data = await response.json();
                
                if (data.length > 0) {
                    renderComparisonData(data);
                } else {
                    // Ø§Ú¯Ø± Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù†ÛŒØ³ØªØŒ Ø³Ø¹ÛŒ Ú©Ù† ÛŒÙ‡ Ø±Ú©ÙˆØ±Ø¯ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†
                    document.getElementById('comparison-table-body').innerHTML = 
                        '<tr><td colspan="6" class="py-4 text-center text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§...</td></tr>';
                    
                    // Ø³Ø¹ÛŒ Ú©Ù† Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø³ØªÛŒ Ø¯Ø§Ø¯Ù‡ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†
                    await createInitialComparisonData();
                }
                
                document.getElementById('comparison-modal').classList.remove('hidden');
            } catch (error) {
                console.error('Error opening comparison modal:', error);
                
                // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø®Ø·Ø§ÛŒ Ø¨Ù‡ØªØ±
                document.getElementById('comparison-table-body').innerHTML = 
                    `<tr><td colspan="6" class="py-4 text-center text-yellow-400">
                        Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ­Ù„ÛŒÙ„. Ù„Ø·ÙØ§Ù‹ ØµÙØ­Ù‡ Ø±Ø§ Ø±ÙØ±Ø´ Ú©Ù†ÛŒØ¯.
                        <br><span class="text-xs text-gray-500">${error.message}</span>
                    </td></tr>`;
                
                document.getElementById('comparison-modal').classList.remove('hidden');
            }
        };

        // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø§Ø¯Ù‡ Ø§ÙˆÙ„ÛŒÙ‡
        const createInitialComparisonData = async () => {
            try {
                // Ø§ÙˆÙ„ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ Ø±Ùˆ Ø¨Ú¯ÛŒØ±
                if (!allPrices || Object.keys(allPrices).length === 0) {
                    await fetchPrices();
                }
                
                // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ø±Ø²Ø´ ÙØ¹Ù„ÛŒ
                const rialAsset = allAssets.find(a => a.symbol === 'RIAL_WALLET');
                const walletBalance = rialAsset ? parseFloat(rialAsset.total_quantity) : 0;
                
                let totalValue = walletBalance;
                allAssets.forEach(asset => {
                    if (asset.symbol !== 'RIAL_WALLET') {
                        totalValue += parseFloat(asset.current_value) || 0;
                    }
                });
                
                // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù‚ÛŒÙ…Øª Ø¯Ù„Ø§Ø± Ùˆ Ø·Ù„Ø§
                let usdPrice = 0;
                let goldPrice = 0;
                
                for (const category in allPrices) {
                    if (allPrices[category]) {
                        allPrices[category].forEach(item => {
                            if (item.symbol === 'USD') usdPrice = item.toman_price;
                            if (item.symbol === 'GOL18') goldPrice = item.toman_price;
                        });
                    }
                }
                
                // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¹Ø§Ø¯Ù„â€ŒÙ‡Ø§
                const equivalentUSD = usdPrice > 0 ? totalValue / usdPrice : 0;
                const equivalentGold = goldPrice > 0 ? totalValue / goldPrice : 0;
                
                // Ø¢Ù¾Ø¯ÛŒØª Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø®Ù„Ø§ØµÙ‡
                document.getElementById('current-value').textContent = formatToman(totalValue);
                document.getElementById('current-usd').textContent = `${equivalentUSD.toFixed(2)} USD`;
                document.getElementById('current-gold').textContent = `${equivalentGold.toFixed(3)} Ú¯Ø±Ù…`;
                document.getElementById('usd-change').textContent = '';
                document.getElementById('gold-change').textContent = '';
                
                // Ù¾ÛŒØ§Ù… Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ
                document.getElementById('comparison-table-body').innerHTML = 
                    `<tr><td colspan="6" class="py-4 text-center text-gray-500">
                        Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ§Ø±ÛŒØ®ÛŒ Ù‡Ù†ÙˆØ² Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ù†Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯.
                        <br><span class="text-xs">Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² Ø§Ù…Ø±ÙˆØ² Ø´Ø±ÙˆØ¹ Ø¨Ù‡ Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</span>
                    </td></tr>`;
                
            } catch (error) {
                console.error('Error creating initial comparison data:', error);
            }
        };

        const renderComparisonData = (data) => {
            const latest = data[data.length - 1];
            
            // Update summary cards
            document.getElementById('current-value').textContent = formatToman(latest.total_value_toman);
            document.getElementById('current-usd').textContent = `${latest.equivalent_usd.toFixed(2)} USD`;
            document.getElementById('current-gold').textContent = `${latest.equivalent_gold_grams.toFixed(3)} Ú¯Ø±Ù…`;
            
            // Update change indicators
            const usdChangeEl = document.getElementById('usd-change');
            const goldChangeEl = document.getElementById('gold-change');
            
            usdChangeEl.textContent = formatPercent(latest.usd_change_percent);
            usdChangeEl.className = `text-xs sm:text-sm mt-1 ${latest.usd_change_percent >= 0 ? 'text-green-400' : 'text-red-400'}`;
            
            goldChangeEl.textContent = formatPercent(latest.gold_change_percent);
            goldChangeEl.className = `text-xs sm:text-sm mt-1 ${latest.gold_change_percent >= 0 ? 'text-green-400' : 'text-red-400'}`;
            
            // Render table
            const tableBody = document.getElementById('comparison-table-body');
            tableBody.innerHTML = '';
            
            // Ù†Ù…Ø§ÛŒØ´ ÙÙ‚Ø· 10 Ø±Ú©ÙˆØ±Ø¯ Ø¢Ø®Ø±
            const displayData = data.slice(-10).reverse();
            
            displayData.forEach(entry => {
                const date = new Date(entry.date).toLocaleDateString('fa-IR');
                
                tableBody.innerHTML += `
                    <tr class="hover:bg-gray-800 transition duration-150">
                        <td class="px-2 py-1 sm:px-3 sm:py-2 text-xs">${date}</td>
                        <td class="px-2 py-1 sm:px-3 sm:py-2 font-mono text-xs sm:text-sm">${formatToman(entry.total_value_toman)}</td>
                        <td class="px-2 py-1 sm:px-3 sm:py-2 font-mono text-xs sm:text-sm">${formatToman(entry.usd_price)}</td>
                        <td class="px-2 py-1 sm:px-3 sm:py-2 font-mono text-xs sm:text-sm">${formatToman(entry.gold_price_per_gram)}</td>
                        <td class="px-2 py-1 sm:px-3 sm:py-2 font-mono text-xs sm:text-sm">${entry.equivalent_usd.toFixed(2)} USD</td>
                        <td class="px-2 py-1 sm:px-3 sm:py-2 font-mono text-xs sm:text-sm">${entry.equivalent_gold_grams.toFixed(3)} Ú¯Ø±Ù…</td>
                    </tr>
                `;
            });
            
            // Render charts if enough data
            if (data.length >= 2) {
                renderComparisonCharts(data);
            } else {
                // Hide charts if not enough data
                document.getElementById('usdChart').style.display = 'none';
                document.getElementById('goldChart').style.display = 'none';
                document.querySelectorAll('h4.text-gray-200').forEach(el => el.style.display = 'none');
            }
        };

        const renderComparisonCharts = (data) => {
            const dates = data.map(d => d.date).reverse();
            const usdValues = data.map(d => d.equivalent_usd).reverse();
            const goldValues = data.map(d => d.equivalent_gold_grams).reverse();
            
            // USD Chart
            const usdCtx = document.getElementById('usdChart').getContext('2d');
            if (usdChart) usdChart.destroy();
            
            usdChart = new Chart(usdCtx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Ø§Ø±Ø²Ø´ Ù…Ø¹Ø§Ø¯Ù„ Ø¯Ù„Ø§Ø±',
                        data: usdValues,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)} USD`
                            }
                        }
                    },
                    scales: {
                        x: { 
                            display: false,
                            grid: { color: '#30363d' }
                        },
                        y: {
                            title: { display: true, text: 'Ø¯Ù„Ø§Ø±', color: '#8b949e' },
                            ticks: { color: '#8b949e' },
                            grid: { color: '#30363d' }
                        }
                    }
                }
            });
            
            // Gold Chart
            const goldCtx = document.getElementById('goldChart').getContext('2d');
            if (goldChart) goldChart.destroy();
            
            goldChart = new Chart(goldCtx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Ø§Ø±Ø²Ø´ Ù…Ø¹Ø§Ø¯Ù„ Ø·Ù„Ø§ (Ú¯Ø±Ù…)',
                        data: goldValues,
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(3)} Ú¯Ø±Ù…`
                            }
                        }
                    },
                    scales: {
                        x: { 
                            display: false,
                            grid: { color: '#30363d' }
                        },
                        y: {
                            title: { display: true, text: 'Ú¯Ø±Ù… Ø·Ù„Ø§', color: '#8b949e' },
                            ticks: { color: '#8b949e' },
                            grid: { color: '#30363d' }
                        }
                    }
                }
            });
        };

        // --- Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø´ÙˆÛŒÛŒâ€ŒÙ‡Ø§ ---
        document.addEventListener('DOMContentLoaded', () => {
            // Ù‡Ù…Ù‡ Ú©Ø´ÙˆÛŒÛŒâ€ŒÙ‡Ø§ Ø±Ùˆ Ø¯Ø± Ø§Ø¨ØªØ¯Ø§ Ø¨Ø³ØªÙ‡ Ù†Ú¯Ù‡ Ø¯Ø§Ø±
            document.querySelectorAll('.category-toggle').forEach(button => {
                const category = button.getAttribute('data-category');
                const content = document.getElementById(`${category}-prices`);
                const arrow = button.querySelector('svg');
                
                if (content && arrow) {
                    content.classList.add('hidden');
                    arrow.style.transform = 'rotate(0deg)';
                }
                
                button.addEventListener('click', () => {
                    const content = document.getElementById(`${category}-prices`);
                    const arrow = button.querySelector('svg');
                    
                    if (content && arrow) {
                        const isHidden = content.classList.contains('hidden');
                        
                        // Ø¨Ø³ØªÙ† Ù‡Ù…Ù‡ Ú©Ø´ÙˆÛŒÛŒâ€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø±
                        document.querySelectorAll('[id$="-prices"]').forEach(el => {
                            if (el.id !== `${category}-prices`) {
                                el.classList.add('hidden');
                            }
                        });
                        
                        // Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ ÙÙ„Ø´â€ŒÙ‡Ø§
                        document.querySelectorAll('.category-toggle svg').forEach(svg => {
                            svg.style.transform = 'rotate(0deg)';
                        });
                        
                        // ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ
                        if (isHidden) {
                            content.classList.remove('hidden');
                            arrow.style.transform = 'rotate(180deg)';
                        } else {
                            content.classList.add('hidden');
                            arrow.style.transform = 'rotate(0deg)';
                        }
                    }
                });
            });
        });

        // --- INITIALIZATION ---
        const initialize = async () => {
            // First time fetch of all necessary data
            await fetchPrices();
            await fetchAssets();
            await fetchChartData();
            await updateDailyProfit();
            
            // Update displays
            updateWalletBalanceDisplay();
            updatePurchasePowerBox();
            updatePurchaseModeUI();
            
            // Start the periodic price update (every 60 seconds)
            setInterval(fetchPrices, 60000);
            setInterval(updateDailyProfit, 300000);  // Ù‡Ø± 5 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø³ÙˆØ¯ Ø±ÙˆØ²Ø§Ù†Ù‡ Ø±Ùˆ Ø¢Ù¾Ø¯ÛŒØª Ú©Ù†
        };
        
        // Start initialization when DOM is loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            initialize();
        }
    </script>
</body>
</html>